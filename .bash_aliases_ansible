# Aliases for the ansible docker image
#
# What the command is doing:
# gather arguments to the variable
# starting docker run command
# remove container after command complete
# allocate a pseudo-tty, keep STDIN open even if not attached
# mounting current directory as ansible working directory
# mounting ssh configuration of current user to the container, read only
#
# To use these:
#
#    1) Copy this file to somewhere (e.g. ~/.bash_aliases_ansible).
#    2) Add the following line to your .bashrc/.zshrc:
#        source ~/.bash_aliases_ansible
#
#   or simply type `. .bash_aliases_ansible` for one time using
#


alias ansible-playbook="__pre_configuration && __ansible_playbook"
alias ansible="__pre_configuration && __ansible"
alias ansible-galaxy="__pre_configuration && __ansible_galaxy"
alias ansible-vault="__pre_configuration && __ansible_vault"
alias ansible-doc="__pre_configuration && __ansible_doc"

__pre_configuration() {
    mkdir -p $HOME/.ansible
    mkdir -p $HOME/.ssh
    touch $HOME/.ssh/config
    touch $HOME/.ssh/known_hosts
    if test -z "$(docker images -q metalguardian/ansible:latest)"; then
        docker pull --quiet metalguardian/ansible:latest
    fi
}

__ansible() {
    local arguments="$@"
    docker run \
        --rm \
        -ti \
        --env TERM \
        --env SSH_AUTH_SOCK \
        --env ANSIBLE_SSH_ARGS \
        --env HOME \
        --user=`id -u`:`id -g` \
        --init \
        --net host \
        -v ${HOME}/.ansible:${HOME}/.ansible \
        -v ${HOME}/.ssh/config:${HOME}/.ssh/config \
        -v ${HOME}/.ssh/known_hosts:${HOME}/.ssh/known_hosts \
        -v $(pwd):$(pwd) -w $(pwd) \
        -v $SSH_AUTH_SOCK:$SSH_AUTH_SOCK \
        metalguardian/ansible \
        ansible \
        ${arguments}
}

__ansible_playbook() {
    local arguments="$@"
    docker run \
        --rm \
        -ti \
        --env TERM \
        --env SSH_AUTH_SOCK \
        --env ANSIBLE_SSH_ARGS \
        --env HOME \
        --user=`id -u`:`id -g` \
        --init \
        --net host \
        -v ${HOME}/.ansible:${HOME}/.ansible \
        -v ${HOME}/.ssh/config:${HOME}/.ssh/config \
        -v ${HOME}/.ssh/known_hosts:${HOME}/.ssh/known_hosts \
        -v $(pwd):$(pwd) -w $(pwd) \
        -v $SSH_AUTH_SOCK:$SSH_AUTH_SOCK \
        metalguardian/ansible \
        ansible-playbook \
        ${arguments}
}

__ansible_galaxy() {
    local arguments="$@"
    docker run \
        --rm \
        -ti \
        --env TERM \
        --env SSH_AUTH_SOCK \
        --env ANSIBLE_SSH_ARGS \
        --env HOME \
        --user=`id -u`:`id -g` \
        --init \
        --net host \
        -v ${HOME}/.ansible:${HOME}/.ansible \
        -v ${HOME}/.ssh/config:${HOME}/.ssh/config \
        -v ${HOME}/.ssh/known_hosts:${HOME}/.ssh/known_hosts \
        -v $(pwd):$(pwd) -w $(pwd) \
        -v $SSH_AUTH_SOCK:$SSH_AUTH_SOCK \
        metalguardian/ansible \
        ansible-galaxy \
        ${arguments}
}

__ansible_vault() {
    local arguments="$@"
    docker run \
        --rm \
        -ti \
        --env TERM \
        --env SSH_AUTH_SOCK \
        --env ANSIBLE_SSH_ARGS \
        --env HOME \
        --user=`id -u`:`id -g` \
        --init \
        --net host \
        -v ${HOME}/.ansible:${HOME}/.ansible \
        -v ${HOME}/.ssh/config:${HOME}/.ssh/config \
        -v ${HOME}/.ssh/known_hosts:${HOME}/.ssh/known_hosts \
        -v $(pwd):$(pwd) -w $(pwd) \
        -v $SSH_AUTH_SOCK:$SSH_AUTH_SOCK \
        metalguardian/ansible \
        ansible-vault \
        ${arguments}
}

__ansible_doc() {
    local arguments="$@"
    docker run \
        --rm \
        -ti \
        --env TERM \
        --env SSH_AUTH_SOCK \
        --env ANSIBLE_SSH_ARGS \
        --env HOME \
        --user=`id -u`:`id -g` \
        --init \
        --net host \
        -v ${HOME}/.ansible:${HOME}/.ansible \
        -v ${HOME}/.ssh/config:${HOME}/.ssh/config \
        -v ${HOME}/.ssh/known_hosts:${HOME}/.ssh/known_hosts \
        -v $(pwd):$(pwd) -w $(pwd) \
        -v $SSH_AUTH_SOCK:$SSH_AUTH_SOCK \
        metalguardian/ansible \
        ansible-doc \
        ${arguments}
}
